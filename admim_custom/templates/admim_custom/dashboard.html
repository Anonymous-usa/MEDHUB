{% extends "base.html" %}

{% block title %}üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2 class="mb-4">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã</h2>

  <!-- –û–±—â–∏–µ –º–µ—Ç—Ä–∏–∫–∏ -->
  <details class="mb-4" open>
    <summary class="summary-toggle h5 mb-2">üìã –û–±—â–∏–µ –º–µ—Ç—Ä–∏–∫–∏</summary>
    <div class="mt-3">
      <table class="table table-bordered table-striped table-hover">
        <thead class="table-light">
          <tr>
            <th>–ú–µ—Ç—Ä–∏–∫–∞</th>
            <th>–ó–Ω–∞—á–µ–Ω–∏–µ</th>
          </tr>
        </thead>
        <tbody>
          <tr><td>–í—Å–µ–≥–æ –∑–∞—è–≤–æ–∫</td><td>{{ stats.appointments_total|default:"0" }}</td></tr>
          <tr><td>–ü—Ä–∏–Ω—è—Ç—ã–µ –∑–∞—è–≤–∫–∏</td><td>{{ stats.appointments_accepted|default:"0" }}</td></tr>
          <tr><td>–û–∂–∏–¥–∞—é—â–∏–µ –∑–∞—è–≤–∫–∏</td><td>{{ stats.appointments_pending|default:"0" }}</td></tr>
          <tr><td>–û—Ç–∫–ª–æ–Ω—ë–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏</td><td>{{ stats.appointments_rejected|default:"0" }}</td></tr>
          <tr><td>–í—Å–µ–≥–æ —É—á—Ä–µ–∂–¥–µ–Ω–∏–π</td><td>{{ stats.institutions_total|default:"0" }}</td></tr>
          <tr><td>–í—Å–µ–≥–æ –≤—Ä–∞—á–µ–π</td><td>{{ stats.doctors_total|default:"0" }}</td></tr>
          <tr><td>–í—Å–µ–≥–æ –æ—Ç–∑—ã–≤–æ–≤</td><td>{{ stats.reviews_total|default:"0" }}</td></tr>
        </tbody>
      </table>
    </div>
  </details>

  <!-- –ì—Ä–∞—Ñ–∏–∫ –∑–∞—è–≤–æ–∫ –ø–æ —Å—Ç–∞—Ç—É—Å—É -->
  <details id="chartDetails">
    <summary class="summary-toggle h5 mt-4">üìà –ó–∞—è–≤–∫–∏ –ø–æ —Å—Ç–∞—Ç—É—Å—É</summary>
    <div class="mt-3" style="height: 320px;">
      <canvas id="appointmentsChart"></canvas>
    </div>
  </details>
</div>

<!-- –°—Ç–∏–ª–∏ -->
<style>
  .summary-toggle {
    cursor: pointer;
    user-select: none;
    list-style: none;
  }
  details > summary::-webkit-details-marker {
    display: none;
  }
  details > summary::before {
    content: "‚ñ∏";
    display: inline-block;
    margin-right: 8px;
    transition: transform 0.2s ease;
  }
  details[open] > summary::before {
    transform: rotate(90deg);
  }
  .table-hover tbody tr:hover {
    background-color: #f8f9fa;
  }
</style>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  (function() {
    const chartDetails = document.getElementById('chartDetails');
    let appointmentsChart = null;

    function initChart() {
      if (appointmentsChart) return;
      const ctx = document.getElementById('appointmentsChart').getContext('2d');
      appointmentsChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['–ü—Ä–∏–Ω—è—Ç—ã–µ', '–û–∂–∏–¥–∞—é—â–∏–µ', '–û—Ç–∫–ª–æ–Ω—ë–Ω–Ω—ã–µ'],
          datasets: [{
            label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞—è–≤–æ–∫',
            data: [
              {{ stats.appointments_accepted|default:"0" }},
              {{ stats.appointments_pending|default:"0" }},
              {{ stats.appointments_rejected|default:"0" }}
            ],
            backgroundColor: ['#198754', '#ffc107', '#dc3545'],
            borderColor: ['#198754', '#ffc107', '#dc3545'],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: { precision: 0 }
            }
          },
          plugins: {
            legend: { display: false },
            tooltip: { enabled: true }
          }
        }
      });
    }

    chartDetails.addEventListener('toggle', () => {
      if (chartDetails.open) {
        requestAnimationFrame(() => {
          initChart();
          if (appointmentsChart) appointmentsChart.resize();
        });
      }
    });

    if (chartDetails.open) {
      initChart();
    }
  })();
</script>
{% endblock %}
